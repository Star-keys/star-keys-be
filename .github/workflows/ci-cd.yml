name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: '21'
  APP_NAME: 'star-keys-be'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: build/reports/tests/test/

  build:
    name: Build Application
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew bootJar

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: build/libs/*.jar
          retention-days: 7

  deploy:
    name: Deploy to EC2
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: ./

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_USER: ec2-user
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          ES_URIS: ${{ secrets.ES_URIS }}
          ES_USERNAME: ${{ secrets.ES_USERNAME }}
          ES_PASSWORD: ${{ secrets.ES_PASSWORD }}
        run: |
          JAR_FILE=$(ls *.jar)
          echo "Deploying $JAR_FILE to EC2..."

          # Create application directory on EC2
          ssh -i ~/.ssh/deploy_key.pem \
              -o StrictHostKeyChecking=no \
              ${EC2_USER}@${EC2_HOST} \
              "sudo mkdir -p /opt/starkeys && sudo chown ${EC2_USER}:${EC2_USER} /opt/starkeys"

          # Copy JAR to EC2
          scp -i ~/.ssh/deploy_key.pem \
              -o StrictHostKeyChecking=no \
              $JAR_FILE \
              ${EC2_USER}@${EC2_HOST}:/opt/starkeys/app.jar

          # Create systemd service and deploy
          ssh -i ~/.ssh/deploy_key.pem \
              -o StrictHostKeyChecking=no \
              ${EC2_USER}@${EC2_HOST} << ENDSSH
            # Create systemd service file
            sudo tee /etc/systemd/system/starkeys.service > /dev/null <<EOF
          [Unit]
          Description=Star Keys Backend Application
          After=network.target

          [Service]
          Type=simple
          User=ec2-user
          WorkingDirectory=/opt/starkeys
          Environment="DB_URL=${DB_URL}"
          Environment="DB_USERNAME=${DB_USERNAME}"
          Environment="DB_PASSWORD=${DB_PASSWORD}"
          Environment="MONGO_URI=${MONGO_URI}"
          Environment="ES_URIS=${ES_URIS}"
          Environment="ES_USERNAME=${ES_USERNAME}"
          Environment="ES_PASSWORD=${ES_PASSWORD}"
          ExecStart=/usr/bin/java -jar /opt/starkeys/app.jar --spring.profiles.active=prod
          Restart=on-failure
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=starkeys

          [Install]
          WantedBy=multi-user.target
          EOF

            # Reload systemd and restart service
            sudo systemctl daemon-reload
            sudo systemctl enable starkeys
            sudo systemctl restart starkeys

            # Wait for application to start
            echo "Waiting for application to start..."
            sleep 10

            # Check service status
            if sudo systemctl is-active --quiet starkeys; then
              echo "âœ… Application started successfully!"
              sudo systemctl status starkeys --no-pager
              echo ""
              echo "ðŸ“‹ Recent logs:"
              sudo journalctl -u starkeys -n 30 --no-pager
            else
              echo "âŒ Failed to start application!"
              sudo systemctl status starkeys --no-pager
              echo ""
              echo "ðŸ“‹ Error logs:"
              sudo journalctl -u starkeys -n 50 --no-pager
              exit 1
            fi
          ENDSSH

      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Performing health check..."
          MAX_RETRIES=6
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s http://${EC2_HOST}:8080/api/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              curl -s http://${EC2_HOST}:8080/api/health | jq .
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check failed (attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in 5 seconds..."
            sleep 5
          done

          echo "âš ï¸  Health check failed after $MAX_RETRIES attempts"
          echo "Application may still be starting up. Check manually: http://${EC2_HOST}:8080/api/health"
          exit 0

      - name: Deployment Summary
        if: success()
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Host**: ${EC2_HOST}" >> $GITHUB_STEP_SUMMARY
          echo "- **User**: ec2-user" >> $GITHUB_STEP_SUMMARY
          echo "- **Application URL**: http://${EC2_HOST}:8080" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: http://${EC2_HOST}:8080/actuator/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed JAR**: $(ls *.jar)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Service Management Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Check status" >> $GITHUB_STEP_SUMMARY
          echo "ssh ec2-user@${EC2_HOST} 'sudo systemctl status starkeys'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "ssh ec2-user@${EC2_HOST} 'sudo journalctl -u starkeys -f'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Restart service" >> $GITHUB_STEP_SUMMARY
          echo "ssh ec2-user@${EC2_HOST} 'sudo systemctl restart starkeys'" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key.pem